Question:

mmap是什么

Answer:

mmap是一种Unix系统调用，用于将文件或设备映射到内存中，并允许应用程序像访问常规内存一样访问它。这种技术使得程序可以直接使用文件或设备中的数据，而无需进行繁琐的I/O操作。通过将数据加载到内存中，程序可以更快地访问和处理大量数据，从而提高性能。mmap通常用于高性能服务器应用程序、数据库管理系统、网络文件系统等领域。

<hr/>

Question:

那请问mmap是如何实现进程间的通信的

Answer:

mmap是通过共享内存来实现进程间通信的。进程可以使用mmap将同一个文件或设备映射到它们各自的虚拟地址空间，因此它们可以通过对共享内存的读写来进行通信。

在使用mmap进行进程间通信时，需要确保每个进程对共享内存的访问不会互相干扰。为此，通常需要使用诸如信号量、互斥锁、条件变量等同步机制来确保数据的同步和一致性。同时，也需要考虑内存映射区的更新和释放等相关问题。因此，在使用mmap进行进程间通信时，需要对通信过程中的各种细节进行仔细的考虑和处理。

<hr/>

Question:

也就是说mmap是在进程内存中的共享区

Answer:

是的，mmap创建的共享内存区域会被映射到进程的地址空间中，从而多个进程可以在自己的地址空间中访问同一个内存区域，实现共享内存的功能。注意：共享内存是在进程内存中的，而不是系统全局内存或物理内存中，因此无法逃避进程地址空间隔离的限制。这也就是为什么使用共享内存时，需要保证多个进程对共享内存区域的访问安全和同步。

<hr/>

Question:

那在mmap的文件什么时候会被系统从内存中重新写回磁盘中呢

Answer:

当使用mmap将文件映射到进程的地址空间后，对映射区域所做的修改并不会直接写回到文件中。相反，内核会缓存这些修改（也就是所谓的“脏页”），并在必要时将它们刷新回磁盘中。

mmap映射的文件所做的修改，会涉及到“页”的概念。页是内存管理中的基本单位，一般大小为4KB，可以通过系统调用mmap、malloc等动态分配和映射。

当对映射区域所做的修改跨越了整数个页时，只有那些被修改的页才会被标记为脏页并写回磁盘。这个过程可能会由操作系统自动完成，也可以通过使用系统调用msync或munmap手动完成。

在使用mmap的应用程序中，通常需要注意及时地将脏页写回到磁盘中，以保证数据的持久化和一致性。

<hr/>

Question:

内核会缓存这些修改？具体是如何缓存这些修改，难道这些修改不是只是在物理内存进行了改动吗

Answer:

是的，这些修改只是在物理内存进行了改动，但是内核会在虚拟内存和物理内存之间维护一张页表，记录虚拟地址和对应物理地址之间的映射关系。当程序需要读取或修改某个虚拟地址的内容时，内核会根据页表将虚拟地址转换为物理地址，然后在物理内存中进行读写操作。

对于mmap映射到用户进程地址空间中的文件，内核会将文件的部分内容缓存到物理内存中，形成所谓的缓存页或缓冲区（page cache或buffer cache）。当用户进程需要访问文件中的某一部分内容时，内核会先检查相应的缓存页是否已经存在，如果存在就直接返回内存中缓存的内容，避免了文件系统的I/O操作。如果缓存页不存在，则内核会进行必要的I/O操作将文件数据从磁盘读入内存，并在页表中新建一条映射关系，以便用户进程继续访问。

当用户进程对mmap映射的文件进行修改时，内核会在页表中标记相应的页为“脏页”，表示该页的内容已经发生了改动。内核维护一个专门的数据结构来跟踪所有的脏页，并在必要时将这些页的内容异步写回到磁盘中。在写回磁盘的过程中，内核会同步更新文件系统元数据，例如文件大小、修改时间等信息，以确保文件系统的一致性。

<hr/>

Question:

也就是说mmap其实不是一下子将对应的文件全部放进内存中的，而是将部分放入，发生缺页中断后再将缺失的部分写入缓存对吗

Answer:

是的，当程序将一个文件通过mmap映射到内存中时，并不是一下子将整个文件全部放进内存中的，而仅仅是取出一部分文件内容，并将其放入内存的缓存（buffer cache）中，以便程序需要时能快速地读取和修改。

如果程序需要访问缓存中尚未加载的部分，那么就会发生缺页中断（page fault），内核会将缺失的页从磁盘中读取到缓存中，并在合适的时机，将缓存中修改过的或脏数据刷入磁盘中，以确保数据的一致性和持久化。这一过程是由操作系统底层的虚拟内存管理机制实现的，对于应用程序来说都是透明的。

需要注意的是，mmap映射文件到内存的时候，操作系统会将文件的内容缓存到内存中，但这并不意味着所有的缓存都是脏数据。只有当程序对缓存中的数据进行修改后，对应的缓存页面才会被标记为“脏页”，并在合适的时候被刷回到磁盘中。

<hr/>

